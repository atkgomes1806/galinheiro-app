/**
 * Cliente HTTP para API ClimAPI da Embrapa
 * 
 * Respons√°vel por:
 * - Autentica√ß√£o OAuth 2.0 Client Credentials
 * - Gerenciamento de token de acesso (cache e renova√ß√£o)
 * - Requisi√ß√µes HTTP autenticadas
 * 
 * API Base: https://api.cnptia.embrapa.br/climapi/v1
 * Documenta√ß√£o: https://api.cnptia.embrapa.br/docs
 */

class EmbrapaApiClient {
  constructor() {
    this.baseURL = import.meta.env.VITE_EMBRAPA_API_URL || 'https://api.cnptia.embrapa.br/climapi/v1';
    this.tokenURL = import.meta.env.VITE_EMBRAPA_TOKEN_URL || 'https://api.cnptia.embrapa.br/token';
    this.consumerKey = import.meta.env.VITE_EMBRAPA_CONSUMER_KEY;
    this.consumerSecret = import.meta.env.VITE_EMBRAPA_CONSUMER_SECRET;
    
    // Cache de token
    this.accessToken = null;
    this.tokenExpiresAt = null;
  }

  /**
   * Codifica credenciais em Base64 para autentica√ß√£o
   * @returns {string} Credenciais codificadas
   */
  encodeCredentials() {
    const credentials = `${this.consumerKey}:${this.consumerSecret}`;
    return btoa(credentials);
  }

  /**
   * Verifica se o token ainda √© v√°lido
   * @returns {boolean} True se token est√° v√°lido
   */
  isTokenValid() {
    if (!this.accessToken || !this.tokenExpiresAt) {
      return false;
    }
    // Considera token inv√°lido 5 minutos antes de expirar (margem de seguran√ßa)
    const now = Date.now();
    const bufferTime = 5 * 60 * 1000; // 5 minutos
    return now < (this.tokenExpiresAt - bufferTime);
  }

  /**
   * Autentica na API e obt√©m token de acesso
   * Utiliza OAuth 2.0 Client Credentials Grant
   * @returns {Promise<string>} Token de acesso
   */
  async authenticate() {
    try {
      console.log('üîê Iniciando autentica√ß√£o OAuth 2.0...');
      console.log('üîë Consumer Key:', this.consumerKey?.substring(0, 10) + '...');
      
      const credentials = this.encodeCredentials();
      console.log('üìù Credenciais codificadas:', credentials.substring(0, 20) + '...');
      
      console.log('üåê POST', this.tokenURL);
      
      const response = await fetch(this.tokenURL, {
        method: 'POST',
        headers: {
          'Authorization': `Basic ${credentials}`,
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'grant_type=client_credentials',
      });

      console.log('üì° Status da resposta:', response.status, response.statusText);

      if (!response.ok) {
        const errorText = await response.text();
        console.error('‚ùå Resposta de erro:', errorText);
        throw new Error(`Falha na autentica√ß√£o: ${response.status} ${response.statusText} - ${errorText}`);
      }

      const data = await response.json();
      console.log('üì¶ Dados recebidos:', JSON.stringify(data).substring(0, 100));
      
      // Armazena token e calcula tempo de expira√ß√£o
      this.accessToken = data.access_token;
      const expiresIn = data.expires_in || 3600; // Padr√£o: 3600 segundos (1 hora)
      this.tokenExpiresAt = Date.now() + (expiresIn * 1000);

      console.log('‚úÖ Autentica√ß√£o Embrapa bem-sucedida!');
      console.log('‚è∞ Token expira em:', new Date(this.tokenExpiresAt).toLocaleTimeString('pt-BR'));
      
      return this.accessToken;
    } catch (error) {
      console.error('‚ùå Erro ao autenticar na API Embrapa:', error.message);
      console.error('Stack:', error.stack);
      throw new Error(`Falha na autentica√ß√£o: ${error.message}`);
    }
  }

  /**
   * Obt√©m token de acesso v√°lido (autentica se necess√°rio)
   * @returns {Promise<string>} Token de acesso v√°lido
   */
  async getValidToken() {
    if (this.isTokenValid()) {
      return this.accessToken;
    }
    return await this.authenticate();
  }

  /**
   * Faz requisi√ß√£o autenticada √† API ClimAPI
   * @param {string} endpoint - Endpoint relativo (ex: '/ncep-gfs')
   * @param {Object} options - Op√ß√µes da requisi√ß√£o fetch
   * @returns {Promise<Object>} Resposta da API
   */
  async request(endpoint, options = {}) {
    try {
      const token = await this.getValidToken();
      
      const url = `${this.baseURL}${endpoint}`;
      console.log('üåê GET', url);
      
      const response = await fetch(url, {
        ...options,
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
          ...options.headers,
        },
      });

      console.log('üì° Status da resposta:', response.status, response.statusText);

      if (!response.ok) {
        const errorText = await response.text();
        console.error('‚ùå Resposta de erro:', errorText);
        throw new Error(`Erro na requisi√ß√£o: ${response.status} ${response.statusText} - ${errorText}`);
      }

      const data = await response.json();
      console.log('‚úÖ Dados recebidos com sucesso');
      
      return data;
    } catch (error) {
      console.error('‚ùå Erro na requisi√ß√£o √† API Embrapa:', error.message);
      console.error('URL:', `${this.baseURL}${endpoint}`);
      throw error;
    }
  }

  /**
   * Obt√©m dados de previs√£o clim√°tica para uma localiza√ß√£o espec√≠fica
   * @param {string} variavel - Vari√°vel clim√°tica (ex: 'tmp2m', 'rh2m')
   * @param {string} data - Data de execu√ß√£o do modelo (formato: YYYYMMDDHH)
   * @param {number} longitude - Longitude da localiza√ß√£o
   * @param {number} latitude - Latitude da localiza√ß√£o
   * @returns {Promise<Object>} Dados clim√°ticos
   */
  async getClimateData(variavel, data, longitude, latitude) {
    const endpoint = `/ncep-gfs/${variavel}/${data}/${longitude}/${latitude}`;
    return await this.request(endpoint);
  }

  /**
   * Obt√©m lista de vari√°veis dispon√≠veis na API
   * @returns {Promise<Array>} Lista de vari√°veis
   */
  async getAvailableVariables() {
    return await this.request('/ncep-gfs');
  }

  /**
   * Obt√©m datas de execu√ß√£o dispon√≠veis para uma vari√°vel
   * @param {string} variavel - Vari√°vel clim√°tica
   * @returns {Promise<Array>} Lista de datas dispon√≠veis
   */
  async getAvailableDates(variavel) {
    return await this.request(`/ncep-gfs/${variavel}`);
  }

  /**
   * Verifica sa√∫de da API
   * @returns {Promise<Object>} Status da API
   */
  async healthCheck() {
    return await this.request('/health');
  }
}

// Exporta inst√¢ncia √∫nica (Singleton)
const embrapaApiClient = new EmbrapaApiClient();
export default embrapaApiClient;
